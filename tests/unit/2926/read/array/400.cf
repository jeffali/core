body common control
{
  bundlesequence  => { "G", "init", "test", "check" };
}

bundle common G
{
  vars:
     "testfile" string => "/tmp/400.txt";
}

bundle agent init
{
files:
	"$(G.testfile)"
	    delete => init_delete;
	
	"$(G.testfile)"
	    create => "true",
	    edit_line => init_fill_in;
}

bundle edit_line init_fill_in
{
insert_lines:

"0:1:2
this:is:a:test
1:2:3";

}

body delete init_delete
{
	dirlinks => "delete";
	rmdirs   => "true";
}

#######################################################

bundle agent test
{
vars:
	"cnt" int => readstringarray("ary", "$(G.testfile)","NoComment",":",10,1000);
	"num" int => "3";
}

#######################################################

bundle agent check
{
vars:
    	"idx" slist => getindices("test.ary");

reports:
    any::
	"expected $(test.num) entries, saw $(test.cnt)";

	"saw array indices '$(idx)'";

	"expected test.ary[0][0] = '0', saw '$(test.ary[0][0])'";
	"expected test.ary[0][1] = '1', saw '$(test.ary[0][1])'";
	"expected test.ary[0][2] = '2', saw '$(test.ary[0][2])'";

	"expected test.ary[this][0] = 'this', saw '$(test.ary[this][0])'";
	"expected test.ary[this][1] = 'is', saw '$(test.ary[this][1])'";
	"expected test.ary[this][2] = 'a', saw '$(test.ary[this][2])'";
	"expected test.ary[this][3] = 'test', saw '$(test.ary[this][3])'";

	"expected test.ary[1][0] = '1', saw '$(test.ary[1][0])'";
	"expected test.ary[1][1] = '2', saw '$(test.ary[1][1])'";
	"expected test.ary[1][2] = '3', saw '$(test.ary[1][2])'";

}
